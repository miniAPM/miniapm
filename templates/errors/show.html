{% extends "layout.html" %}

{% block title %}Error Details - MiniAPM{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<style>
    [data-theme="light"] .source-code pre code { background: #f6f8fa; }
    .source-code {
        display: flex;
        font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, monospace;
        font-size: 13px;
        line-height: 1.5;
        overflow-x: auto;
        border-radius: 6px;
        background: var(--code-bg, #161b22);
    }
    .source-code pre { margin: 0; flex: 1; overflow-x: auto; }
    .source-code code {
        display: block;
        padding: 0.75rem 1rem;
        background: transparent !important;
        white-space: pre;
    }
    .source-code .hljs { background: transparent !important; padding: 0; }
    .source-code .line-numbers {
        display: flex;
        flex-direction: column;
        padding: 0.75rem 0.75rem 0.75rem 1rem;
        text-align: right;
        color: var(--text-muted);
        border-right: 1px solid var(--border);
        user-select: none;
        background: rgba(0,0,0,0.1);
    }
    .source-code .line-numbers span {
        line-height: 1.5;
    }
    .source-code .line-numbers .error-line {
        color: var(--danger);
        font-weight: bold;
    }
</style>
{% endblock %}

{% block project_selector %}
{% if ctx.show_selector() %}
<form method="POST" action="/projects/switch" class="project-selector">
    <select name="slug" onchange="this.form.submit()">
        {% for project in ctx.projects %}
        <option value="{{ project.slug }}" {% if ctx.is_current_project(project.id) %}selected{% endif %}>
            {{ project.name }}
        </option>
        {% endfor %}
    </select>
</form>
{% endif %}
{% endblock %}

{% block content %}
{% match error %}
{% when Some with (e) %}
<h1>{{ e.exception_class }}</h1>

<div class="error-header">
    <div class="error-meta">
        <span class="badge badge-{{ e.status }}">{{ e.status }}</span>
        <span>{{ e.occurrence_count }} occurrences</span>
        <span>First: {{ e.first_seen_at }}</span>
        <span>Last: {{ e.last_seen_at }}</span>
        {% if !trend_24h.is_empty() %}
        <span class="error-sparkline-container">
            <span class="sparkline-label">24h:</span>
            <canvas id="errorSparkline" width="100" height="24"></canvas>
        </span>
        {% endif %}
    </div>
    <div class="error-actions">
        {% if e.status != "resolved" %}
        <form method="POST" action="/errors/{{ e.id }}/status" class="inline-status-form">
            <input type="hidden" name="status" value="resolved">
            <button type="submit" class="btn btn-success btn-sm">Mark Resolved</button>
        </form>
        {% endif %}
        {% if e.status != "ignored" %}
        <form method="POST" action="/errors/{{ e.id }}/status" class="inline-status-form">
            <input type="hidden" name="status" value="ignored">
            <button type="submit" class="btn btn-muted btn-sm">Ignore</button>
        </form>
        {% endif %}
        {% if e.status != "open" %}
        <form method="POST" action="/errors/{{ e.id }}/status" class="inline-status-form">
            <input type="hidden" name="status" value="open">
            <button type="submit" class="btn btn-outline btn-sm">Reopen</button>
        </form>
        {% endif %}
    </div>
</div>

{% if !trend_24h.is_empty() %}
<script>
(function() {
    const data = [{% for val in trend_24h %}{{ val }},{% endfor %}];
    const canvas = document.getElementById('errorSparkline');
    if (!canvas || data.length === 0) return;

    const ctx = canvas.getContext('2d');
    const dpr = window.devicePixelRatio || 1;
    const width = 100;
    const height = 24;

    canvas.width = width * dpr;
    canvas.height = height * dpr;
    canvas.style.width = width + 'px';
    canvas.style.height = height + 'px';
    ctx.scale(dpr, dpr);

    const dangerColor = getComputedStyle(document.documentElement).getPropertyValue('--danger').trim() || '#e74c3c';
    const maxVal = Math.max(...data, 1);
    const stepX = width / (data.length - 1 || 1);
    const padding = 2;
    const chartHeight = height - padding * 2;

    // Draw area fill
    ctx.fillStyle = dangerColor + '30';
    ctx.beginPath();
    ctx.moveTo(0, height - padding);
    data.forEach((val, i) => {
        const x = i * stepX;
        const y = padding + chartHeight - (val / maxVal) * chartHeight;
        ctx.lineTo(x, y);
    });
    ctx.lineTo(width, height - padding);
    ctx.closePath();
    ctx.fill();

    // Draw line
    ctx.strokeStyle = dangerColor;
    ctx.lineWidth = 1.5;
    ctx.beginPath();
    data.forEach((val, i) => {
        const x = i * stepX;
        const y = padding + chartHeight - (val / maxVal) * chartHeight;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
    });
    ctx.stroke();
})();
</script>
{% endif %}

<div class="card">
    <h2>Message</h2>
    <pre class="error-message">{{ e.message }}</pre>
</div>

<div class="card">
    <h2>Recent Occurrences</h2>
    {% if occurrences.is_empty() %}
    <p class="empty">No occurrences found</p>
    {% else %}
    {% for occ in occurrences %}
    <div class="occurrence">
        <div class="occurrence-header">
            <span>{{ occ.happened_at }}</span>
            {% if let Some(user_id) = occ.user_id.as_ref() %}
            <span>User: {{ user_id }}</span>
            {% endif %}
        </div>
        {% if let Some(sctx) = occ.source_context.as_ref() %}
        <div class="source-context" data-file="{{ sctx.file }}" data-error-line="{{ sctx.lineno }}">
            <div class="source-header">
                <span class="source-file">{{ sctx.file }}</span>
                <span class="source-lineno">line {{ sctx.lineno }}</span>
            </div>
            <div class="source-code">
                <div class="line-numbers">
{% for line in sctx.pre_context_with_lines() %}<span>{{ line.0 }}</span>
{% endfor %}<span class="error-line">{{ sctx.lineno }}</span>
{% for line in sctx.post_context_with_lines() %}<span>{{ line.0 }}</span>
{% endfor %}</div>
                <pre><code>{% for line in sctx.pre_context_with_lines() %}{{ line.1 }}
{% endfor %}{{ sctx.context_line }}
{% for line in sctx.post_context_with_lines() %}{{ line.1 }}
{% endfor %}</code></pre>
            </div>
        </div>
        {% endif %}
        <pre class="backtrace">{% for line in occ.backtrace %}{{ line }}
{% endfor %}</pre>
    </div>
    {% endfor %}
    {% endif %}
</div>

{% when None %}
<h1>Error not found</h1>
<p><a href="/errors">Back to errors</a></p>
{% endmatch %}
{% endblock %}

{% block extra_scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/ruby.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/typescript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/go.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/rust.min.js"></script>
<script>
(function() {
    const extToLang = {
        'rb': 'ruby', 'erb': 'ruby',
        'py': 'python',
        'js': 'javascript', 'jsx': 'javascript', 'mjs': 'javascript',
        'ts': 'typescript', 'tsx': 'typescript',
        'go': 'go',
        'rs': 'rust'
    };

    document.querySelectorAll('.source-context').forEach(ctx => {
        const file = ctx.dataset.file || '';
        const ext = file.split('.').pop().toLowerCase();
        const lang = extToLang[ext] || '';
        const code = ctx.querySelector('code');
        if (code && lang) {
            code.classList.add('language-' + lang);
        }
        if (code) {
            hljs.highlightElement(code);
        }
    });
})();
</script>
{% endblock %}
